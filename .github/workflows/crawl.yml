name: Crawl Skills

# Multi-token support:
# The crawler supports multiple GitHub tokens for higher rate limits.
# Each token from a DIFFERENT account adds 5000 req/hour capacity.
#
# Required secrets:
#   - PAT_TOKEN or GITHUB_TOKEN: Primary token (required)
#
# Optional secrets (from different GitHub accounts):
#   - EXTRA_TOKEN_1 .. EXTRA_TOKEN_5: Additional tokens
#
# For "re-trigger when incomplete": a PAT with "workflow" scope (GITHUB_TOKEN
# cannot trigger new runs). Set WORKFLOW_DISPATCH_TOKEN to enable auto re-run.
#
# Note: EXTRA_TOKEN_ prefix because GitHub Actions reserves GITHUB_ prefix

on:
  # Run daily at 00:00 UTC; if crawl is incomplete, workflow re-triggers itself
  schedule:
    - cron: "0 0 * * *"

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (don't commit changes)"
        required: false
        default: "false"
        type: boolean

  # Also run on push to main when skills or crawler changes
  push:
    branches:
      - main
    paths:
      - "skills/**"
      - "crawler/**"
      - ".github/workflows/crawl.yml"

# Only one crawl at a time; re-triggered and scheduled runs queue
concurrency:
  group: crawl-skills
  cancel-in-progress: false

jobs:
  crawl:
    runs-on: ubuntu-latest
    # Public repos: max 6h. Crawler uses ~5h; leave headroom for setup/commit.
    timeout-minutes: 320

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Restore crawler cache
        uses: actions/cache@v4
        with:
          path: crawler/.crawler-cache.json
          key: crawler-cache-${{ github.run_id }}
          restore-keys: |
            crawler-cache-

      - name: Restore zip cache
        uses: actions/cache@v4
        with:
          path: market/zips
          key: skill-zips-${{ github.run_id }}
          restore-keys: |
            skill-zips-

      - name: Run crawler
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          EXTRA_TOKEN_1: ${{ secrets.EXTRA_TOKEN_1 }}
          EXTRA_TOKEN_2: ${{ secrets.EXTRA_TOKEN_2 }}
          EXTRA_TOKEN_3: ${{ secrets.EXTRA_TOKEN_3 }}
          EXTRA_TOKEN_4: ${{ secrets.EXTRA_TOKEN_4 }}
          EXTRA_TOKEN_5: ${{ secrets.EXTRA_TOKEN_5 }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
        run: npm run crawl

      - name: Check for changes
        id: check_changes
        run: |
          git add -f market/skills.json market/skills-*.json
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -f market/skills.json market/skills-*.json
          git commit -m "chore: update skills data [skip ci]

          Automated update from crawler run at $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          git push

      # When crawl fully complete (same condition as re-trigger: all false â†’ complete), trigger deploy-web.
      - name: Check if crawl complete
        id: crawl_complete
        if: success()
        run: |
          INCOMPLETE=$(jq -r 'if .meta.rateLimited == true or .meta.timedOut == true or .meta.zipTimedOut == true then "yes" else "no" end' market/skills.json 2>/dev/null || echo "yes")
          if [ "$INCOMPLETE" != "yes" ]; then
            echo "complete=true" >> $GITHUB_OUTPUT
          else
            echo "complete=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger deploy-web
        if: steps.crawl_complete.outputs.complete == 'true'
        env:
          TOKEN: ${{ secrets.WORKFLOW_DISPATCH_TOKEN }}
        run: |
          if [ -z "$TOKEN" ]; then
            echo "WORKFLOW_DISPATCH_TOKEN not set; skipping deploy-web trigger."
            exit 0
          fi
          echo "Crawl complete (no rate limit/timeout), triggering Deploy Web workflow..."
          curl -sS -X POST \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/deploy-web.yml/dispatches" \
            -d '{"ref":"main"}'
          echo "Deploy Web triggered."

      - name: Summary
        run: |
          echo "## Crawl Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          TOTAL=$(jq '.meta.totalSkills' market/skills.json)
          LOCAL=$(jq '.meta.localSkills' market/skills.json)
          PRIORITY=$(jq '.meta.prioritySkills // 0' market/skills.json)
          REMOTE=$(jq '.meta.remoteSkills' market/skills.json)
          RATE_LIMITED=$(jq '.meta.rateLimited // false' market/skills.json)
          TIMED_OUT=$(jq '.meta.timedOut // false' market/skills.json)
          EXEC_TIME_MS=$(jq '.meta.executionTimeMs // 0' market/skills.json)
          EXEC_TIME_MIN=$((EXEC_TIME_MS / 60000))
          EXEC_TIME_SEC=$(((EXEC_TIME_MS % 60000) / 1000))
          CHUNKS=$(jq '.meta.chunks // [] | length' market/skills.json)
          MAIN_SKILLS=$(jq '.skills | length' market/skills.json)
          echo "| Source | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Local (PR submitted) | $LOCAL |" >> $GITHUB_STEP_SUMMARY
          echo "| Priority Repos | $PRIORITY |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Search | $REMOTE |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Execution time**: ${EXEC_TIME_MIN}m ${EXEC_TIME_SEC}s" >> $GITHUB_STEP_SUMMARY
          if [ "$CHUNKS" -gt 0 ]; then
            echo "**Chunks**: $((CHUNKS + 1)) files (${MAIN_SKILLS} skills in main + ${CHUNKS} chunk files)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$RATE_LIMITED" == "true" ]; then
            echo "> **Warning**: Crawl was incomplete due to GitHub API rate limiting." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$TIMED_OUT" == "true" ]; then
            echo "> **Warning**: Crawl was incomplete due to execution timeout." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
              echo "**Status**: Dry run - changes not committed" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Status**: Changes committed successfully" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "**Status**: No changes detected" >> $GITHUB_STEP_SUMMARY
          fi

      # If crawl was incomplete (timeout/rate limit), trigger this workflow again.
      # Requires WORKFLOW_DISPATCH_TOKEN (PAT with "workflow" scope); GITHUB_TOKEN cannot trigger new runs.
      - name: Re-trigger workflow if incomplete
        if: success()
        env:
          TOKEN: ${{ secrets.WORKFLOW_DISPATCH_TOKEN }}
        run: |
          INCOMPLETE=$(jq -r 'if .meta.rateLimited == true or .meta.timedOut == true or .meta.zipTimedOut == true then "yes" else "no" end' market/skills.json 2>/dev/null || echo "no")
          if [ "$INCOMPLETE" != "yes" ]; then
            echo "Crawl complete, no re-trigger."
            exit 0
          fi
          if [ -z "$TOKEN" ]; then
            echo "Crawl incomplete but WORKFLOW_DISPATCH_TOKEN not set; skipping re-trigger."
            echo "Set a PAT with workflow scope to enable auto re-run until complete."
            exit 0
          fi
          echo "Crawl incomplete (rate limit/timeout), triggering workflow again..."
          curl -sS -X POST \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/crawl.yml/dispatches" \
            -d '{"ref":"main"}'
          echo "Workflow re-triggered (queued by concurrency)."
