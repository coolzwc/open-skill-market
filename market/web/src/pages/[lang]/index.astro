---
import BaseLayout from "@/layouts/BaseLayout.astro";
import SkillList from "@/components/SkillList.astro";
import { getLang, MESSAGES, type Lang } from "@/lib/i18n";
import { loadMainMarketData } from "@/lib/market-data";

export const prerender = true;

export async function getStaticPaths() {
  return [{ params: { lang: "en" } }, { params: { lang: "zh" } }];
}

const lang = getLang(Astro.params.lang) as Lang;
const t = MESSAGES[lang];
const altLang = lang === "en" ? "zh" : "en";
const market = await loadMainMarketData();

const categoryCounts: Record<string, number> = {};
for (const skill of market.skills) {
  for (const category of skill.categories || []) {
    categoryCounts[category] = (categoryCounts[category] || 0) + 1;
  }
}
const categories = Object.keys(categoryCounts).sort((a, b) => {
  if (a === "Other") return 1;
  if (b === "Other") return -1;
  return a.localeCompare(b);
});

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  name: t.siteName,
  description: t.siteDescription,
  numberOfItems: market.meta.totalSkills,
  itemListElement: market.skills.slice(0, 20).map((skill, idx) => ({
    "@type": "ListItem",
    position: idx + 1,
    name: skill.name,
    url: `https://open-skill-market.pages.dev/${lang}/skill/${encodeURIComponent(skill.id)}`
  }))
};
---

<BaseLayout
  lang={lang}
  title={`${t.siteName} | ${t.navHome}`}
  description={t.siteDescription}
  canonicalPath={`/${lang}/`}
  altPath={`/${altLang}/`}
>
  <!-- Topbar -->
  <header class="topbar">
    <a class="brand" href={`/${lang}/`}>{t.siteName}</a>
    <div class="topbar-search">
      <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8" /><path d="m21 21-4.35-4.35" />
      </svg>
      <input id="skill-search" type="search" placeholder={t.searchPlaceholder} />
    </div>
    <div class="topbar-right">
      <a class="gh-link" href="https://github.com/coolzwc/open-skill-market" target="_blank" rel="noreferrer" aria-label="GitHub">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.3 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61-.546-1.385-1.335-1.755-1.335-1.755-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.694.825.576C20.565 21.795 24 17.295 24 12c0-6.63-5.37-12-12-12"/></svg>
      </a>
      <nav class="lang-switch" aria-label={t.language}>
        <a href="/en/" class={lang === "en" ? "active" : ""}>EN</a>
        <a href="/zh/" class={lang === "zh" ? "active" : ""}>中文</a>
      </nav>
    </div>
  </header>

  <!-- Sidebar + Main -->
  <div class="page-shell">
    <aside class="sidebar">
      <div class="sidebar-title">{t.categoryLabel}</div>
      <button class="sidebar-item active" data-category="">
        <span class="sidebar-item-label">{t.allCategories}</span>
        <span class="sidebar-count">{market.meta.totalSkills}</span>
      </button>
      <div class="sidebar-sep"></div>
      {categories.map((category) => (
        <button class="sidebar-item" data-category={category}>
          <span class="sidebar-item-label">{category}</span>
          <span class="sidebar-count">{categoryCounts[category]}</span>
        </button>
      ))}
    </aside>

    <div class="main-content">
      <!-- Hero -->
      <section class="hero animate-in">
        <h1>{t.heroTitle}</h1>
        <p>{t.heroSubtitle}</p>
        <div class="meta-line delay-1 animate-in">
          <span class="dot"></span>
          <span>{market.meta.totalSkills} skills indexed</span>
          <span>&middot;</span>
          <span>{t.updatedAt} {new Date(market.meta.generatedAt).toLocaleDateString(lang === "zh" ? "zh-CN" : "en-US")}</span>
        </div>
      </section>

      <!-- Mobile category horizontal scroll -->
      <div class="mobile-category-bar" id="mobile-cats">
        <button class="mobile-cat-chip active" data-category="">{t.allCategories}</button>
        {categories.map((category) => (
          <button class="mobile-cat-chip" data-category={category}>{category}</button>
        ))}
      </div>

      <SkillList
        lang={lang}
        initialSkills={market.skills}
        initialRepositories={market.repositories}
        chunkFiles={market.meta.chunks || []}
        categories={categories}
      />

      <footer class="site-footer">
        &copy; {new Date().getFullYear()} <a href="https://github.com/coolzwc/open-skill-market" target="_blank" rel="noreferrer">Open Skill Market</a>. MIT License.
      </footer>
    </div>
  </div>

  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
</BaseLayout>

<script>
  // Wire sidebar + mobile chip category selection
  function initCategoryNav() {
    const sidebarItems = document.querySelectorAll<HTMLButtonElement>(".sidebar-item[data-category]");
    const mobileChips = document.querySelectorAll<HTMLButtonElement>(".mobile-cat-chip[data-category]");
    const categorySelect = document.querySelector<HTMLInputElement>("#skill-category-hidden");

    function activate(cat: string) {
      sidebarItems.forEach((item) => item.classList.toggle("active", item.dataset.category === cat));
      mobileChips.forEach((chip) => chip.classList.toggle("active", chip.dataset.category === cat));
      if (categorySelect) {
        categorySelect.value = cat;
        categorySelect.dispatchEvent(new Event("change"));
      }
    }

    sidebarItems.forEach((item) => item.addEventListener("click", () => activate(item.dataset.category || "")));
    mobileChips.forEach((chip) => chip.addEventListener("click", () => activate(chip.dataset.category || "")));
  }

  initCategoryNav();
</script>
